<div class="modal-header">
  <h5 class="modal-title">QR Code Details</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

{% if success_message %}
<div class="alert alert-success m-3">{{ success_message }}</div>
{% endif %}

<div class="modal-body">
  <!-- QR Image Section -->
  <div class="text-center mb-3">
    <div class="form-check form-switch d-flex justify-content-center align-items-center mb-2">
      <input class="form-check-input me-2" type="checkbox" id="includeLogo">
      <label class="form-check-label" for="includeLogo">Include Logo</label>
    </div>
    <img id="qrImage" src="/api/v1/qr/{{ qr.id }}/image?image_format=png&size=10" alt="QR Code" class="img-fluid border" style="max-width: 250px;">
  </div>

  <!-- Title & Description Card -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Title & Description</h6>
    </div>
    <div class="card-body">
      <div class="row mb-2">
        <div class="col-4 fw-bold">Title:</div>
        <div class="col-8">{{ qr.title or "Untitled QR Code" }}</div>
      </div>
      {% if qr.description %}
      <div class="row mb-2">
        <div class="col-4 fw-bold">Description:</div>
        <div class="col-8">{{ qr.description }}</div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Basic Information Card -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Basic Information</h6>
    </div>
    <div class="card-body">
      <div class="row mb-2">
        <div class="col-4 fw-bold">ID:</div>
        <div class="col-8">{{ qr.id }}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-bold">Type:</div>
        <div class="col-8">{{ qr.qr_type|title }}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-bold">Created:</div>
        <div class="col-8">{{ created_at_formatted }}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-bold">Error Level:</div>
        <div class="col-8" id="errorLevelDisplay">{{ error_level_display }}</div>
      </div>
      {% if qr.qr_type == "dynamic" and short_url %}
      <div class="row mb-2">
        <div class="col-4 fw-bold">Short URL:</div>
        <div class="col-8">
          <a href="/r/{{ short_id }}" target="_blank">{{ short_url }}</a>
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="navigator.clipboard.writeText('{{ short_url }}')">
            <i class="bi bi-clipboard"></i> Copy
          </button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Content Section for Static QR Codes -->
  {% if qr.qr_type == "static" %}
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Content</h6>
    </div>
    <div class="card-body">
      <p class="text-break mb-0">
        {% if qr.content.startswith('http') %}
          <a href="{{ qr.content }}" target="_blank">{{ qr.content }}</a>
        {% else %}
          {{ qr.content }}
        {% endif %}
      </p>
    </div>
  </div>
  {% endif %}
  
  <!-- Redirect URL for Dynamic QR Codes -->
  {% if qr.qr_type == "dynamic" %}
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Destination URL</h6>
    </div>
    <div class="card-body">
      <p class="text-break mb-0">
        <a href="{{ qr.redirect_url }}" target="_blank">{{ qr.redirect_url }}</a>
      </p>
    </div>
  </div>
  {% endif %}
  
  <!-- Usage Statistics Card -->
  {% if qr.qr_type == "dynamic" %}
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Usage Statistics</h6>
    </div>
    <div class="card-body">
      {% if has_scan_data %}
      <div class="row mb-2">
        <div class="col-4 fw-bold">Scan Count:</div>
        <div class="col-8">{{ qr.scan_count }}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-bold">Last Scanned:</div>
        <div class="col-8">{{ last_scan_formatted }}</div>
      </div>
      <div class="alert alert-info mb-0 mt-3 small">
        <i class="bi bi-info-circle me-2"></i> More detailed statistics including device types and geographic data will be available soon in the upcoming dedicated statistics page.
      </div>
      {% else %}
      <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle me-2"></i> This QR code has not been scanned yet.
        <div class="mt-2 small">More detailed statistics will appear here after the first scan.</div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  <!-- Coming Soon Notification -->
  <div class="alert alert-primary small">
    <i class="bi bi-graph-up me-2"></i> <strong>Coming Soon:</strong> A dedicated statistics page with enhanced metrics including device types, geographic data, and scan patterns.
  </div>

  <!-- Physical Dimensions Card (if provided) -->
  {% if physical_size is defined and physical_unit is defined and dpi is defined %}
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Physical Dimensions</h6>
    </div>
    <div class="card-body">
      <div class="row mb-2">
        <div class="col-4 fw-bold">Size:</div>
        <div class="col-8">{{ physical_size }} {{ physical_unit }}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-bold">DPI:</div>
        <div class="col-8">{{ dpi }}</div>
      </div>
      <div class="alert alert-info mb-0 small">
        <i class="bi bi-info-circle me-2"></i> These physical dimensions will be applied when downloading or viewing the QR code.
      </div>
    </div>
  </div>
  {% endif %}
</div>

<div class="modal-footer">
  <!-- Download Options Section -->
  <div class="row mb-3 w-100">
    <div class="col-lg-6">
      <div class="d-flex align-items-center mb-2">
        <span class="fw-bold me-3">Download Options:</span>
      </div>
      <div class="form-check mb-2">
        <input type="checkbox" class="form-check-input" id="includeLogo" onchange="updateImageAndDownloadLinks()">
        <label class="form-check-label" for="includeLogo">Include Logo</label>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="mb-2">
        <label class="form-label fw-bold">Physical Dimensions (Optional)</label>
      </div>
      <div class="row g-2">
        <div class="col-4">
          <input type="number" class="form-control form-control-sm" id="physicalSize" placeholder="Size" min="0.1" max="100" step="0.1" onchange="updateImageAndDownloadLinks()">
        </div>
        <div class="col-4">
          <select class="form-select form-select-sm" id="physicalUnit" onchange="updateImageAndDownloadLinks()">
            <option value="">Unit</option>
            <option value="in">Inches (in)</option>
            <option value="cm">Centimeters (cm)</option>
            <option value="mm">Millimeters (mm)</option>
          </select>
        </div>
        <div class="col-4">
          <input type="number" class="form-control form-control-sm" id="dpi" placeholder="DPI" min="72" max="1200" step="1" onchange="updateImageAndDownloadLinks()">
        </div>
      </div>
      <div class="text-muted small mt-1">
        All fields required if any is used
      </div>
      <div class="mt-2">
        <span class="small me-1">Presets:</span>
        <button type="button" class="btn btn-sm btn-outline-secondary me-1" 
                onclick="applyPreset(2, 'in', 300)">Business Card</button>
        <button type="button" class="btn btn-sm btn-outline-secondary me-1" 
                onclick="applyPreset(5, 'cm', 300)">Small</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" 
                onclick="applyPreset(12, 'in', 300)">Poster</button>
      </div>
    </div>
  </div>

  <div class="btn-group me-auto">
    <a href="/api/v1/qr/{{ qr.id }}/image?image_format=png&size=10" id="pngDownload" download="qr-{{ qr.id }}.png" class="btn btn-secondary">
      <i class="bi bi-file-image me-1"></i> PNG
    </a>
    <a href="/api/v1/qr/{{ qr.id }}/image?image_format=svg&size=10" id="svgDownload" download="qr-{{ qr.id }}.svg" class="btn btn-secondary">
      <i class="bi bi-filetype-svg me-1"></i> SVG
    </a>
    <a href="/api/v1/qr/{{ qr.id }}/image?image_format=jpeg&size=10" id="jpgDownload" download="qr-{{ qr.id }}.jpg" class="btn btn-secondary">
      <i class="bi bi-file-image me-1"></i> JPG
    </a>
    <a href="/api/v1/qr/{{ qr.id }}/image?image_format=webp&size=10" id="webpDownload" download="qr-{{ qr.id }}.webp" class="btn btn-secondary">
      <i class="bi bi-file-image me-1"></i> WebP
    </a>
  </div>
  
  <button
    hx-get="/api/v1/fragments/qr-edit/{{ qr.id }}"
    hx-target="#qr-detail-modal .modal-content"
    class="btn btn-primary"
  >
    <i class="bi bi-pencil me-1"></i> Edit QR Code
  </button>
  
  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
</div>

<div id="formatNote" class="small text-muted mt-2 text-center" style="display: none;">
  Note: SVG format does not support logo embedding. Use PNG, JPG, or WebP formats for QR codes with logos.
</div>

<script>
  // Update image and download links when options change
  function updateImageAndDownloadLinks() {
    const logoChecked = document.getElementById('includeLogo').checked;
    const physicalSize = document.getElementById('physicalSize').value.trim();
    const physicalUnit = document.getElementById('physicalUnit').value;
    const dpi = document.getElementById('dpi').value.trim();
    
    // Base parameters
    const logoParam = logoChecked ? '&include_logo=true' : '';
    const errorParam = logoChecked ? '&error_level=h' : '';
    const sizeParam = logoChecked ? '&size=20' : '&size=10';
    
    // Check if all physical dimension fields are filled
    let physicalParams = '';
    if (physicalSize && physicalUnit && dpi) {
      physicalParams = `&physical_size=${physicalSize}&physical_unit=${physicalUnit}&dpi=${dpi}`;
    }
    
    // Create base URL for each format
    const basePngUrl = `/api/v1/qr/{{ qr.id }}/image?image_format=png${sizeParam}${logoParam}${errorParam}${physicalParams}`;
    const baseSvgUrl = `/api/v1/qr/{{ qr.id }}/image?image_format=svg${sizeParam}${logoParam}${errorParam}${physicalParams}`;
    const baseJpgUrl = `/api/v1/qr/{{ qr.id }}/image?image_format=jpeg${sizeParam}${logoParam}${errorParam}${physicalParams}`;
    const baseWebpUrl = `/api/v1/qr/{{ qr.id }}/image?image_format=webp${sizeParam}${logoParam}${errorParam}${physicalParams}`;
    
    // Update image source
    document.getElementById('qrImage').src = basePngUrl;
    
    // Update error level display
    document.getElementById('errorLevelDisplay').textContent = logoChecked ? 'H (High - for logo)' : '{{ error_level_display }}';
    
    // Update download links
    document.getElementById('pngDownload').href = basePngUrl;
    document.getElementById('svgDownload').href = baseSvgUrl;
    document.getElementById('jpgDownload').href = baseJpgUrl;
    document.getElementById('webpDownload').href = baseWebpUrl;
    
    // Create descriptive filenames based on options
    let filenameBase = `qr-{{ qr.id }}`;
    if (physicalSize && physicalUnit && dpi) {
      filenameBase += `-${physicalSize}${physicalUnit}-${dpi}dpi`;
    }
    if (logoChecked) {
      filenameBase += '-logo';
    }
    
    // Update download filenames
    document.getElementById('pngDownload').download = `${filenameBase}.png`;
    document.getElementById('svgDownload').download = `${filenameBase}.svg`;
    document.getElementById('jpgDownload').download = `${filenameBase}.jpg`;
    document.getElementById('webpDownload').download = `${filenameBase}.webp`;
    
    // Show/hide the format note based on logo selection
    document.getElementById('formatNote').style.display = logoChecked ? 'block' : 'none';
  }
  
  // Initialize on load
  document.addEventListener('DOMContentLoaded', function() {
    // Set initial form state
    document.getElementById('includeLogo').checked = false;
    
    // Try to pre-populate physical dimensions if they were already set
    {% if physical_size is defined and physical_unit is defined and dpi is defined %}
    document.getElementById('physicalSize').value = '{{ physical_size }}';
    document.getElementById('physicalUnit').value = '{{ physical_unit }}';
    document.getElementById('dpi').value = '{{ dpi }}';
    {% endif %}
    
    // Update links based on initial state
    updateImageAndDownloadLinks();
  });

  // Optional: Add presets for common sizes
  function applyPreset(size, unit, dpi) {
    document.getElementById('physicalSize').value = size;
    document.getElementById('physicalUnit').value = unit;
    document.getElementById('dpi').value = dpi;
    updateImageAndDownloadLinks();
  }
</script> 